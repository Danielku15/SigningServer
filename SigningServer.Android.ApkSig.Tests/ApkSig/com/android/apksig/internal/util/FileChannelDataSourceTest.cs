// <auto-generated>
// This code was auto-generated.
// Changes to this file may cause incorrect behavior and will be lost if
// the code is regenerated.
// </auto-generated>

using System;
using System.IO;
using NUnit.Framework;

namespace SigningServer.Android.Com.Android.Apksig.Internal.Util
{
    
    public class FileChannelDataSourceTest: SigningServer.Android.TestBase
    {
        public DirectoryInfo temporaryFolder;

        [SetUp]
        public void SetUp()
        {
            temporaryFolder = CreateTemporaryFolder();
        }

        [TearDown]
        public void Cleanup()
        {
            if (temporaryFolder.Exists)
            {
                temporaryFolder.Delete(true);
            }
        }
        
        [Test]
        public virtual void TestFeedsCorrectData_whenFilePartiallyReadFromBeginning()
        {
            byte[] fullFileContent = SigningServer.Android.Com.Android.Apksig.Internal.Util.FileChannelDataSourceTest.CreateFileContent(1024 * 1024 + 987654);
            SigningServer.Android.IO.RandomAccessFile raf = CreateRaf(fullFileContent);
            Com.Android.Apksig.Util.DataSource rafDataSource = new Com.Android.Apksig.Internal.Util.FileChannelDataSource(raf.GetChannel());
            Com.Android.Apksig.Internal.Util.ByteArrayDataSink dataSink = new Com.Android.Apksig.Internal.Util.ByteArrayDataSink();
            int bytesToFeed = 1024 * 1024 + 12345;
            rafDataSource.Feed(0, bytesToFeed, dataSink);
            byte[] expectedBytes = SigningServer.Android.Collections.Arrays.CopyOf(fullFileContent, bytesToFeed);
            byte[] resultBytes = SigningServer.Android.Com.Android.Apksig.Internal.Util.FileChannelDataSourceTest.GetDataSinkBytes(dataSink);
            AssertArrayEquals(expectedBytes, resultBytes);
        }
        
        [Test]
        public virtual void TestFeedsCorrectData_whenFilePartiallyReadWithOffset()
        {
            byte[] fullFileContent = SigningServer.Android.Com.Android.Apksig.Internal.Util.FileChannelDataSourceTest.CreateFileContent(1024 * 1024 + 987654);
            SigningServer.Android.IO.RandomAccessFile raf = CreateRaf(fullFileContent);
            Com.Android.Apksig.Util.DataSource rafDataSource = new Com.Android.Apksig.Internal.Util.FileChannelDataSource(raf.GetChannel());
            Com.Android.Apksig.Internal.Util.ByteArrayDataSink dataSink = new Com.Android.Apksig.Internal.Util.ByteArrayDataSink();
            int offset = 23456;
            int bytesToFeed = 1024 * 1024 + 12345;
            rafDataSource.Feed(offset, bytesToFeed, dataSink);
            byte[] expectedBytes = SigningServer.Android.Collections.Arrays.CopyOfRange(fullFileContent, offset, offset + bytesToFeed);
            byte[] resultBytes = SigningServer.Android.Com.Android.Apksig.Internal.Util.FileChannelDataSourceTest.GetDataSinkBytes(dataSink);
            AssertArrayEquals(expectedBytes, resultBytes);
        }
        
        [Test]
        public virtual void TestFeedsCorrectData_whenSeveralMbRead()
        {
            byte[] fullFileContent = SigningServer.Android.Com.Android.Apksig.Internal.Util.FileChannelDataSourceTest.CreateFileContent(3 * 1024 * 1024 + 987654);
            SigningServer.Android.IO.RandomAccessFile raf = CreateRaf(fullFileContent);
            Com.Android.Apksig.Util.DataSource rafDataSource = new Com.Android.Apksig.Internal.Util.FileChannelDataSource(raf.GetChannel());
            Com.Android.Apksig.Internal.Util.ByteArrayDataSink dataSink = new Com.Android.Apksig.Internal.Util.ByteArrayDataSink();
            int offset = 23456;
            int bytesToFeed = 2 * 1024 * 1024 + 12345;
            rafDataSource.Feed(offset, bytesToFeed, dataSink);
            byte[] expectedBytes = SigningServer.Android.Collections.Arrays.CopyOfRange(fullFileContent, offset, offset + bytesToFeed);
            byte[] resultBytes = SigningServer.Android.Com.Android.Apksig.Internal.Util.FileChannelDataSourceTest.GetDataSinkBytes(dataSink);
            AssertArrayEquals(expectedBytes, resultBytes);
        }
        
        internal static byte[] GetDataSinkBytes(Com.Android.Apksig.Internal.Util.ByteArrayDataSink dataSink)
        {
            SigningServer.Android.IO.ByteBuffer result = dataSink.GetByteBuffer(0, (int)dataSink.Size());
            byte[] resultBytes = new byte[result.Limit()];
            result.Get(resultBytes);
            return resultBytes;
        }
        
        internal static byte[] CreateFileContent(int fileSize)
        {
            byte[] fullFileContent = new byte[fileSize];
            for (int i = 0;i < fileSize;++i)
            {
                fullFileContent[i] = (byte)(i % 255);
            }
            return fullFileContent;
        }
        
        internal SigningServer.Android.IO.RandomAccessFile CreateRaf(byte[] content)
        {
            System.IO.FileInfo dataFile = new FileInfo(Path.Combine(temporaryFolder.FullName, Guid.NewGuid().ToString("N")));
            using(SigningServer.Android.IO.FileOutputStream fos = new SigningServer.Android.IO.FileOutputStream(dataFile))
            {
                fos.Write(content);
            }
            return new SigningServer.Android.IO.RandomAccessFile(dataFile, "r");
        }
        
    }
    
}
