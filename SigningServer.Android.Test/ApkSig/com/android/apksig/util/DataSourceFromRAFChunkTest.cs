// <auto-generated>
// This code was auto-generated.
// Changes to this file may cause incorrect behavior and will be lost if
// the code is regenerated.
// </auto-generated>

using System;
using System.IO;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using SigningServer.Android.Com.Android.Apksig.Internal.Util;
using SigningServer.Android.IO;

namespace SigningServer.Android.Com.Android.Apksig.Util
{
    /// <summary>
    /// Tests for the {@link DataSource} returned by
    /// {@link DataSources#asDataSource(RandomAccessFile, long, long)}.
    /// </summary>
    public abstract class DataSourceFromRAFChunkTestBase : SigningServer.Android.Com.Android.Apksig.Util.DataSourceTestBase
    {
        public abstract Com.Android.Apksig.Util.DataSource Create(SigningServer.Android.IO.RandomAccessFile file, long offset, long size);
        
        [Test]
        [Ignore("Concurrent file modification strangely leads to wait on file read which never returns")]
        public virtual void TestFileSizeChangesNotVisible()
        {
            using(SigningServer.Android.Com.Android.Apksig.Util.DataSourceTestBase.CloseableWithDataSource c = CreateDataSource("abcdefg"))
            {
                Com.Android.Apksig.Util.DataSource ds = c.GetDataSource();
                Com.Android.Apksig.Util.DataSource slice = ds.Slice(3, 2);
                System.IO.FileInfo f = ((SigningServer.Android.Com.Android.Apksig.Util.DataSourceFromRAFTestBase.TmpFileCloseable)c.GetCloseable()).GetFile();
                SigningServer.Android.Com.Android.Apksig.Util.DataSourceTestBase.AssertGetByteBufferEquals("abcdefg", ds, 0, (int)ds.Size());
                SigningServer.Android.Com.Android.Apksig.Util.DataSourceTestBase.AssertGetByteBufferEquals("de", slice, 0, (int)slice.Size());
                SigningServer.Android.Com.Android.Apksig.Util.DataSourceTestBase.AssertFeedEquals("cdefg", ds, 2, 5);
                SigningServer.Android.Com.Android.Apksig.Util.DataSourceTestBase.AssertFeedEquals("e", slice, 1, 1);
                SigningServer.Android.Com.Android.Apksig.Util.DataSourceTestBase.AssertCopyToEquals("cdefg", ds, 2, 5);
                SigningServer.Android.Com.Android.Apksig.Util.DataSourceTestBase.AssertCopyToEquals("e", slice, 1, 1);
                SigningServer.Android.Com.Android.Apksig.Util.DataSourceTestBase.AssertSliceEquals("cdefg", ds, 2, 5);
                SigningServer.Android.Com.Android.Apksig.Util.DataSourceTestBase.AssertSliceEquals("e", slice, 1, 1);
                using(SigningServer.Android.IO.RandomAccessFile raf = new SigningServer.Android.IO.RandomAccessFile(f, "rw"))
                {
                    raf.Seek(raf.Length());
                    raf.Write("hijkl".GetBytes(SigningServer.Android.IO.Charset.StandardCharsets.UTF_8));
                }
                SigningServer.Android.Com.Android.Apksig.Util.DataSourceTestBase.AssertGetByteBufferEquals("abcdefg", ds, 0, (int)ds.Size());
                SigningServer.Android.Com.Android.Apksig.Util.DataSourceTestBase.AssertGetByteBufferEquals("de", slice, 0, (int)slice.Size());
                SigningServer.Android.Com.Android.Apksig.Util.DataSourceTestBase.AssertGetByteBufferThrowsIOOB(ds, 0, (int)ds.Size() + 3);
                SigningServer.Android.Com.Android.Apksig.Util.DataSourceTestBase.AssertFeedThrowsIOOB(ds, 0, (int)ds.Size() + 3);
                SigningServer.Android.Com.Android.Apksig.Util.DataSourceTestBase.AssertSliceThrowsIOOB(ds, 0, (int)ds.Size() + 3);
                SigningServer.Android.Com.Android.Apksig.Util.DataSourceTestBase.AssertCopyToThrowsIOOB(ds, 0, (int)ds.Size() + 3);
            }
        }
        
        protected override SigningServer.Android.Com.Android.Apksig.Util.DataSourceTestBase.CloseableWithDataSource CreateDataSource(byte[] contents)
        {
            byte[] fullContents = new byte[2 + contents.Length + 1];
            fullContents[0] = (byte)'0';
            fullContents[1] = (byte)'1';
            SigningServer.Android.Core.System.Arraycopy(contents, 0, fullContents, 2, contents.Length);
            fullContents[fullContents.Length - 1] = (byte)'9';
            System.IO.FileInfo tmp = CreateTemporaryFile(typeof(SigningServer.Android.Com.Android.Apksig.Util.DataSourceFromRAFChunkTest).Name, ".bin");
            SigningServer.Android.IO.RandomAccessFile f = null;
            try
            {
                File.WriteAllBytes(tmp.FullName, fullContents);
                f = new SigningServer.Android.IO.RandomAccessFile(tmp, "r");
            }
            finally
            {
                if (f == null)
                {
                    tmp.Delete();
                }
            }
            return SigningServer.Android.Com.Android.Apksig.Util.DataSourceTestBase.CloseableWithDataSource.Of(Create(f, 2, contents.Length), new SigningServer.Android.Com.Android.Apksig.Util.DataSourceFromRAFTestBase.TmpFileCloseable(tmp, f));
        }
    }

    [TestClass]
    public class DataSourceFromRAFChunkTest :DataSourceFromRAFChunkTestBase
    {
        public override DataSource Create(RandomAccessFile file, long offset, long size)
        {
            return DataSources.AsDataSource(file, offset, size);
        }
    }
    
    [TestClass]
    public class DataSourceFromFileChannelChunkTest :DataSourceFromRAFChunkTestBase 
    {
        public override DataSource Create(RandomAccessFile file, long offset, long size)
        {
            return DataSources.AsDataSource(file.GetChannel(), offset, size);
        }
    }
    
}
