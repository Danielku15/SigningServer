// <auto-generated>
// This code was auto-generated.
// Changes to this file may cause incorrect behavior and will be lost if
// the code is regenerated.
// </auto-generated>

using System;

namespace SigningServer.Android.Com.Android.Apksig.Util
{
    /// <summary>
    /// Tests for the {@link DataSource} returned by
    /// {@link DataSources#asDataSource(RandomAccessFile, long, long)}.
    /// </summary>
    [RunWith(typeof(var))]
    public class DataSourceFromRAFChunkTest: SigningServer.Android.Com.Android.Apksig.Util.DataSourceTestBase
    {
        [Parameterized.Parameters(Name = "{0}")]
        public static SigningServer.Android.Com.Android.Apksig.Util.DataSourceFromRAFFactory[] Data()
        {
            return DataSourceFromRAFFactory.Values();
        }
        
        [Parameterized.Parameter]
        public SigningServer.Android.Com.Android.Apksig.Util.DataSourceFromRAFFactory factory;
        
        [Test]
        public virtual void TestFileSizeChangesNotVisible()
        {
            using(SigningServer.Android.Com.Android.Apksig.Util.DataSourceTestBase.CloseableWithDataSource c = CreateDataSource("abcdefg"))
            {
                Com.Android.Apksig.Util.DataSource ds = c.GetDataSource();
                Com.Android.Apksig.Util.DataSource slice = ds.Slice(3, 2);
                System.IO.FileInfo f = ((SigningServer.Android.Com.Android.Apksig.Util.DataSourceFromRAFTest.TmpFileCloseable)c.GetCloseable()).GetFile();
                SigningServer.Android.Com.Android.Apksig.Util.DataSourceTestBase.AssertGetByteBufferEquals("abcdefg", ds, 0, (int)ds.Size());
                SigningServer.Android.Com.Android.Apksig.Util.DataSourceTestBase.AssertGetByteBufferEquals("de", slice, 0, (int)slice.Size());
                SigningServer.Android.Com.Android.Apksig.Util.DataSourceTestBase.AssertFeedEquals("cdefg", ds, 2, 5);
                SigningServer.Android.Com.Android.Apksig.Util.DataSourceTestBase.AssertFeedEquals("e", slice, 1, 1);
                SigningServer.Android.Com.Android.Apksig.Util.DataSourceTestBase.AssertCopyToEquals("cdefg", ds, 2, 5);
                SigningServer.Android.Com.Android.Apksig.Util.DataSourceTestBase.AssertCopyToEquals("e", slice, 1, 1);
                SigningServer.Android.Com.Android.Apksig.Util.DataSourceTestBase.AssertSliceEquals("cdefg", ds, 2, 5);
                SigningServer.Android.Com.Android.Apksig.Util.DataSourceTestBase.AssertSliceEquals("e", slice, 1, 1);
                using(SigningServer.Android.IO.RandomAccessFile raf = new SigningServer.Android.IO.RandomAccessFile(f, "rw"))
                {
                    raf.Seek(raf.Length());
                    raf.Write("hijkl".GetBytes(SigningServer.Android.IO.Charset.StandardCharsets.UTF_8));
                }
                SigningServer.Android.Com.Android.Apksig.Util.DataSourceTestBase.AssertGetByteBufferEquals("abcdefg", ds, 0, (int)ds.Size());
                SigningServer.Android.Com.Android.Apksig.Util.DataSourceTestBase.AssertGetByteBufferEquals("de", slice, 0, (int)slice.Size());
                SigningServer.Android.Com.Android.Apksig.Util.DataSourceTestBase.AssertGetByteBufferThrowsIOOB(ds, 0, (int)ds.Size() + 3);
                SigningServer.Android.Com.Android.Apksig.Util.DataSourceTestBase.AssertFeedThrowsIOOB(ds, 0, (int)ds.Size() + 3);
                SigningServer.Android.Com.Android.Apksig.Util.DataSourceTestBase.AssertSliceThrowsIOOB(ds, 0, (int)ds.Size() + 3);
                SigningServer.Android.Com.Android.Apksig.Util.DataSourceTestBase.AssertCopyToThrowsIOOB(ds, 0, (int)ds.Size() + 3);
            }
        }
        
        protected override SigningServer.Android.Com.Android.Apksig.Util.DataSourceTestBase.CloseableWithDataSource CreateDataSource(sbyte[] contents)
        {
            sbyte[] fullContents = new sbyte[2 + contents.Length + 1];
            fullContents[0] = '0';
            fullContents[1] = '1';
            SigningServer.Android.Core.System.Arraycopy(contents, 0, fullContents, 2, contents.Length);
            fullContents[fullContents.Length - 1] = '9';
            System.IO.FileInfo tmp = System.IO.FileInfo.CreateTempFile(typeof(SigningServer.Android.Com.Android.Apksig.Util.DataSourceFromRAFChunkTest).GetSimpleName(), ".bin");
            SigningServer.Android.IO.RandomAccessFile f = null;
            try
            {
                SigningServer.Android.IO.File.Files.Write(tmp.ToPath(), fullContents);
                f = new SigningServer.Android.IO.RandomAccessFile(tmp, "r");
            }
            finally
            {
                if (f == null)
                {
                    tmp.Delete();
                }
            }
            return SigningServer.Android.Com.Android.Apksig.Util.DataSourceTestBase.CloseableWithDataSource.Of(factory.Create(f, 2, contents.Length), new SigningServer.Android.Com.Android.Apksig.Util.DataSourceFromRAFTest.TmpFileCloseable(tmp, f));
        }
        
    }
    
}
