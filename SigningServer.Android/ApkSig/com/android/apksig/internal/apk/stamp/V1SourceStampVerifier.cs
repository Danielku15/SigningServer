// <auto-generated>
// This code was auto-generated.
// Changes to this file may cause incorrect behavior and will be lost if
// the code is regenerated.
// </auto-generated>

using System;

namespace SigningServer.Android.Com.Android.Apksig.Internal.Apk.Stamp
{
    /// <summary>
    /// Source Stamp verifier.
    /// 
    /// &lt;p&gt;V1 of the source stamp verifies the stamp signature of at most one signature scheme.
    /// </summary>
    public abstract class V1SourceStampVerifier
    {
        /// <summary>
        /// Hidden constructor to prevent instantiation.
        /// </summary>
        internal V1SourceStampVerifier()
        {
        }
        
        /// <summary>
        /// Verifies the provided APK's SourceStamp signatures and returns the result of verification.
        /// The APK must be considered verified only if {@link ApkSigningBlockUtils.Result#verified} is
        /// {@code true}. If verification fails, the result will contain errors -- see {@link
        /// ApkSigningBlockUtils.Result#getErrors()}.
        /// 
        /// @throws NoSuchAlgorithmException if the APK's signatures cannot be verified because a
        ///     required cryptographic algorithm implementation is missing
        /// @throws ApkSigningBlockUtils.SignatureNotFoundException if no SourceStamp signatures are
        ///     found
        /// @throws IOException if an I/O error occurs when reading the APK
        /// </summary>
        public static SigningServer.Android.Com.Android.Apksig.Internal.Apk.ApkSigningBlockUtils.Result Verify(SigningServer.Android.Com.Android.Apksig.Util.DataSource apk, SigningServer.Android.Com.Android.Apksig.Apk.ApkUtils.ZipSections zipSections, sbyte[] sourceStampCertificateDigest, SigningServer.Android.Collections.Map<SigningServer.Android.Com.Android.Apksig.Internal.Apk.ContentDigestAlgorithm, sbyte[]> apkContentDigests, int minSdkVersion, int maxSdkVersion)
        {
            SigningServer.Android.Com.Android.Apksig.Internal.Apk.ApkSigningBlockUtils.Result result = new SigningServer.Android.Com.Android.Apksig.Internal.Apk.ApkSigningBlockUtils.Result(SigningServer.Android.Com.Android.Apksig.Internal.Apk.ApkSigningBlockUtils.VERSION_SOURCE_STAMP);
            SigningServer.Android.Com.Android.Apksig.Internal.Apk.SignatureInfo signatureInfo = SigningServer.Android.Com.Android.Apksig.Internal.Apk.ApkSigningBlockUtils.FindSignature(apk, zipSections, SigningServer.Android.Com.Android.Apksig.Internal.Apk.Stamp.SourceStampConstants.V1_SOURCE_STAMP_BLOCK_ID, result);
            SigningServer.Android.Com.Android.Apksig.Internal.Apk.Stamp.V1SourceStampVerifier.Verify(
                signatureInfo.signatureBlock
                , 
                sourceStampCertificateDigest
                , 
                apkContentDigests
                , 
                minSdkVersion
                , 
                maxSdkVersion
                , 
                result
            
            );
            return result;
        }
        
        /// <summary>
        /// Verifies the provided APK's SourceStamp signatures and outputs the results into the provided
        /// {@code result}. APK is considered verified only if there are no errors reported in the {@code
        /// result}. See {@link #verify(DataSource, ApkUtils.ZipSections, byte[], Map, int, int)} for
        /// more information about the contract of this method.
        /// </summary>
        internal static void Verify(SigningServer.Android.IO.ByteBuffer sourceStampBlock, sbyte[] sourceStampCertificateDigest, SigningServer.Android.Collections.Map<SigningServer.Android.Com.Android.Apksig.Internal.Apk.ContentDigestAlgorithm, sbyte[]> apkContentDigests, int minSdkVersion, int maxSdkVersion, SigningServer.Android.Com.Android.Apksig.Internal.Apk.ApkSigningBlockUtils.Result result)
        {
            SigningServer.Android.Com.Android.Apksig.Internal.Apk.ApkSigningBlockUtils.Result.SignerInfo signerInfo = new SigningServer.Android.Com.Android.Apksig.Internal.Apk.ApkSigningBlockUtils.Result.SignerInfo();
            result.signers.Add(signerInfo);
            try
            {
                SigningServer.Android.Security.Cert.CertificateFactory certFactory = SigningServer.Android.Security.Cert.CertificateFactory.GetInstance("X.509");
                SigningServer.Android.IO.ByteBuffer sourceStampBlockData = SigningServer.Android.Com.Android.Apksig.Internal.Apk.ApkSigningBlockUtils.GetLengthPrefixedSlice(sourceStampBlock);
                sbyte[] digestBytes = SigningServer.Android.Com.Android.Apksig.Internal.Apk.ApkSigningBlockUtils.EncodeAsSequenceOfLengthPrefixedPairsOfIntAndLengthPrefixedBytes(SigningServer.Android.Com.Android.Apksig.Internal.Apk.Stamp.V1SourceStampVerifier.GetApkDigests(apkContentDigests));
                SigningServer.Android.Com.Android.Apksig.Internal.Apk.Stamp.SourceStampVerifier.VerifyV1SourceStamp(
                    sourceStampBlockData
                    , 
                    certFactory
                    , 
                    signerInfo
                    , 
                    digestBytes
                    , 
                    sourceStampCertificateDigest
                    , 
                    minSdkVersion
                    , 
                    maxSdkVersion
                
                );
                result.verified = !result.ContainsErrors() && !result.ContainsWarnings();
            }
            catch (SigningServer.Android.Security.Cert.CertificateException e)
            {
                throw new System.InvalidOperationException("Failed to obtain X.509 CertificateFactory", e);
            }
            catch (System.Exception e) when ( e is SigningServer.Android.Com.Android.Apksig.Apk.ApkFormatException || e is SigningServer.Android.IO.BufferUnderflowException)
            {
                signerInfo.AddWarning(SigningServer.Android.Com.Android.Apksig.ApkVerifier.Issue.SOURCE_STAMP_MALFORMED_SIGNATURE);
            }
        }
        
        internal static SigningServer.Android.Collections.List<SigningServer.Android.Com.Android.Apksig.Internal.Util.Pair<int?, sbyte[]>> GetApkDigests(SigningServer.Android.Collections.Map<SigningServer.Android.Com.Android.Apksig.Internal.Apk.ContentDigestAlgorithm, sbyte[]> apkContentDigests)
        {
            SigningServer.Android.Collections.List<SigningServer.Android.Com.Android.Apksig.Internal.Util.Pair<int?, sbyte[]>> digests = new SigningServer.Android.Collections.List<SigningServer.Android.Com.Android.Apksig.Internal.Util.Pair<int?, sbyte[]>>();
            foreach (SigningServer.Android.Collections.MapEntry<SigningServer.Android.Com.Android.Apksig.Internal.Apk.ContentDigestAlgorithm, sbyte[]> apkContentDigest in apkContentDigests.EntrySet())
            {
                digests.Add(SigningServer.Android.Com.Android.Apksig.Internal.Util.Pair.Of(apkContentDigest.GetKey().GetId(), apkContentDigest.GetValue()));
            }
            SigningServer.Android.Util.Collections.Sort(digests, System.Collections.Generic.IComparer.Comparing(SigningServer.Android.Com.Android.Apksig.Internal.Util.Pair.getFirst));
            return digests;
        }
        
    }
    
}
